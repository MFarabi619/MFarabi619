name: ðŸ¤–CI

on:
    pull_request:
    push:
        branches: ["main"]

    workflow_dispatch:

jobs:
    nix:
        strategy:
            matrix:
                # os: [ubuntu-latest, macos-latest]
                os: [ubuntu-latest]
        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              # with:
              #     ref: ${{ github.head_ref }}

            - name: â… Install Nix
              uses: cachix/install-nix-action@v31

            - name: Setup Cachix
              uses: cachix/cachix-action@v16
              with:
                  name: devenv

            - name: ðŸ’» Install Devenv
              run: nix profile add nixpkgs#devenv

            # - name: Build the devenv shell and run any pre-commit hooks
            #   run: devenv test

            # - name: Run a single command in the devenv shell
            #   run: devenv shell hello

            # - name: Run a multi-line command in the devenv shell
            #   shell: devenv shell bash -- -e {0}
            #   run: |
            #       pnpx playwright@1.56.1 install
            #       cargo run -p e2e

    rustfmt:
        name: Check Style
        runs-on: ubuntu-latest

        env:
            RUST_TOOLCHAIN: stable
            TOOLCHAIN_PROFILE: minimal

        permissions:
            contents: read

        steps:
            - name: Checkout the code
              uses: actions/checkout@v4

            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: ${{ env.RUST_TOOLCHAIN }}
                  components: rustfmt

            - name: Run cargo fmt
              uses: actions-rs/cargo@v1
              with:
                  command: fmt
                  args: --all -- --check

    clippy:
        name: Run Clippy
        runs-on: ubuntu-latest

        env:
            RUST_TOOLCHAIN: stable
            TOOLCHAIN_PROFILE: minimal

        permissions:
            contents: read

        steps:
            - name: Checkout the code
              uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: ${{ env.RUST_TOOLCHAIN }}
            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
            - name: Run cargo clippy
              uses: actions-rs/cargo@v1
              with:
                  command: clippy
                  args: --all-features -- -D warnings -W clippy::pedantic -W clippy::nursery -W rust-2018-idioms

    # test:
    #     name: Run Tests
    #     runs-on: ubuntu-latest

    #     env:
    #         RUST_TOOLCHAIN: stable
    #         TOOLCHAIN_PROFILE: minimal

    #     permissions:
    #         contents: read

    #     services:
    #         redis:
    #             image: redis
    #             options: >-
    #                 --health-cmd "redis-cli ping"
    #                 --health-interval 10s
    #                 --health-timeout 5s
    #                 --health-retries 5
    #             ports:
    #                 - "6379:6379"
    #         postgres:
    #             image: postgres
    #             env:
    #                 POSTGRES_DB: postgres_test
    #                 POSTGRES_USER: postgres
    #                 POSTGRES_PASSWORD: postgres
    #             ports:
    #                 - "5432:5432"
    #             # Set health checks to wait until postgres has started
    #             options: --health-cmd pg_isready
    #                 --health-interval 10s
    #                 --health-timeout 5s
    #                 --health-retries 5

    #     steps:
    #         - name: Checkout the code
    #           uses: actions/checkout@v4

    #         - uses: dtolnay/rust-toolchain@stable
    #           with:
    #               toolchain: ${{ env.RUST_TOOLCHAIN }}

    #         - name: Setup Rust cache
    #           uses: Swatinem/rust-cache@v2

    #         - name: Install system dependencies
    #           run: |
    #               sudo apt-get update
    #               sudo apt-get install -y --no-install-recommends \
    #                 pkg-config \
    #                 libglib2.0-dev \
    #                 libwebkit2gtk-4.1-dev \
    #                 libgtk-3-dev \
    #                 libgdk-pixbuf-2.0-dev \
    #                 libcairo2-dev \
    #                 libpango1.0-dev \
    #                 libatk1.0-dev \
    #                 libgirepository1.0-dev

    #         - name: Run cargo test
    #           uses: actions-rs/cargo@v1
    #           with:
    #               command: test
    #               args: --all-features --all
    #           env:
    #               REDIS_URL: redis://localhost:${{job.services.redis.ports[6379]}}
    #               DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres_test
