Work in Progress.

=man tuning=

*** Connect to network

=bsdconfig= or =dhclient ue0=

*** Enable =sudo=

*** Set up shell
#+begin_src bash
pkg update && pkg upgrade
#+end_src

#+begin_src bash
sudo pkg install bash zsh git
#+end_src
[[https://ohmyz.sh/][Oh My Zsh]]
#+begin_src bash
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
#+end_src

[[https://github.com/romkatv/powerlevel10k][PowerLevel10K]]
#+begin_src bash
git clone https://github.com/romkatv/powerlevel10k.git $ZSH_CUSTOM/themes/powerlevel10k
#+end_src

[[https://github.com/chrissicool/zsh-256color][zsh-256color]]
#+begin_src bash
cd $ZSH_CUSTOM/plugins && git clone https://github.com/chrissicool/zsh-256color
#+end_src

[[https://github.com/zsh-users/zsh-autosuggestions][zsh-autosuggestions]]
#+begin_src bash
git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
#+end_src

[[https://github.com/zsh-users/zsh-syntax-highlighting][zsh-syntax-highlighting]]
#+begin_src bash
git clone https://github.com/zsh-users/zsh-syntax-highlighting ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
#+end_src

Source =~/.zshrc=:
#+begin_src bash
git clone https://github.com/MFarabi619/MFarabi619
rm ~/.zshrc;
ln -s /home/mfarabi/MFarabi619/configurations/freebsd/.zshrc ~/.zshrc;
rm ~/.p10k.zsh;
ln -s /home/mfarabi/MFarabi619/configurations/freebsd/.p10k.zsh ~/.p10k.zsh;
rm -rf ~/.config/hypr;
ln -s /home/mfarabi/MFarabi619/modules/home/programs/hyprland/hypr /home/mfarabi/.config/hypr;
source ~/.zshrc;
#+end_src

#+begin_src bash
sudo pkg install nix yazi curl bat lazygit zellij jetbrains-mono nerd-fonts noto-emoji npm vips lf terminfo-db direnv
#+end_src

#+begin_src bash
sudo /usr/local/share/nix/add-nixbld-users 12
#+end_src

#+begin_src bash
fc-cache -fv
#+end_src

#+begin_src bash
sudo ya pkg add yazi-rs/plugins:{git,mime-ext,smart-enter,smart-filter,smart-paste,chmod,mount,toggle-pane,vcs-files,zoom}
#+end_src

#+begin_src bash
sudo pkg install tailscale systeroid gh ttyd sysutils/lazyssh television
#+end_src

#+begin_src bash
sudo sysrc tailscaled_enable="YES"
#+end_src


#+begin_src bash
sudo pkg install btop fastfetch cmatrix cowsay asciiquarium figlet {lol,nyan}cat rgb-tui
#+end_src

#+begin_src bash
curl -fsSL https://git.io/shellspec | sh
#+end_src

#+begin_src bash
/home/mfarabi/.local/lib/shellspec/bin/shellspec . --format documentation
#+end_src

*** Set up editors

#+begin_src bash
sudo pkg install tree eza fzf ripgrep ripgrep-all cmake markdown markdownfmt zig go python
 wget tree-{sitter,sitter-{cli,graph,grammars}} shfmt vim neovim py311-pynvim emacs-devel ffmpegthumbnailer coreutils poppler {un,7-}zip aspell en-aspell aspell-ispell
#+end_src

#+begin_src bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
#+end_src

[[https://www.lazyvim.org/installation][Lazyvim]]
#+begin_src bash
git clone https://github.com/LazyVim/starter ~/.config/nvim; rm -rf ~/.config/nvim/.git;
#+end_src

[[https://github.com/doomemacs/doomemacs?tab=readme-ov-file#install][Doom Emacs]]
#+begin_src bash
git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.config/emacs;
~/.config/emacs/bin/doom install;
rm -rf ~/.config/doom/*;
ln -s /home/mfarabi/MFarabi619/modules/home/programs/emacs/* /home/mfarabi/.config/doom/
doom sync
#+end_src

*** Set up FreeBSD Hyprland

1. Add user to =video= group
  #+begin_src bash
  pw groupmod video -m mfarabi; groups mfarabi;
  #+end_src

- Switch to root user then visudo.

wheel NOPASSWD all

#+begin_src bash
sudo pkg install sensors dbus kitty vlc dunst mpv texlive-full firefox webcamd gimp-jxl-plugin mousepad \
    swww sddm sddm-freebsd-black-theme \
    xdg-{terminal-exec,desktop-portal,desktop-portal-hyprland} \
    rofi wlogout dolphin swaylock-effects \
    {fontpre,epdf,pwc}view glcapsviewer cairo pipewire grim slurp \
    hypr{land,land-qt-support,graphics,lang,utils,wayland-scanner,sunset,idle,lock,paper,picker} \
    way{land,bar} wayland-{logout,protocols,utils} qt6-{wayland,imageformats} xwayland xwayland-{satellite,run} wl-{clipboard,screenrec,gammarelay-rs} \
    cava nwg-{look,dock-hyprland} {network,wifi}mgr byobu nsxiv pa{ngo,vucontrol,mixer,-applet} wmwifi aimage qimageblitz xloadimage terminal-image-viewer
#+end_src

#+begin_src bash
sudo sysrc webcamd_enable=YES
#+end_src
#+begin_src bash
sudo service devd restart
#+end_src
#+begin_src bash
sudo pw groupmod webcamd -m mfarabi
#+end_src
#+begin_src bash
sudo kldload cuse
#+end_src
#+begin_src bash
sudo sysrc kld_list+=cuse
sudo sysrc kld_list+=coretemp
#+end_src
#+begin_src bash
sudo webcamd -l
#+end_src

 # imlib2-jxl xwaylandvideobridge hyprland-qtutils kvantum sysctl-tui

Add to =/boot/loader.conf=
#+begin_src bash
sysctlinfo_load="YES"
# hw.nvidiadrm.modeset="1" # if using nvidia-drm-kmod
sysctlbyname_improved_load="YES"
#+end_src

#+begin_src bash
sudo kldload fusefs
#+end_src

#+begin_src bash
sudo pkg install bsd{-splash-changer,ebfetch,info,sensors} pwcbsd wmbsdbatt openconnect-freebsd-daemon viewglob sysctlview
#+end_src

#+begin_src bash
sudo pkg install ly
#+end_src

#+begin_src bash
Add the following entry to /etc/gettytab:

Ly:\
	:lo=/usr/local/bin/ly:\
	:al=root:

#+end_src

Modify the command field of the ttyv1 terminal entry in /etc/ttys

#+begin_src bash
ttyv1   "/usr/libexec/getty Ly"     xterm onifexists secure
#+end_src

Make sure that "tty" is set appropriately in the /usr/local/etc/ly/config.ini file if
you decide to configure a different TTY for Ly instead.


2. Install packages

#+begin_src bash
sudo pkg install procs s-tui stress smartmontools gnupg {sys,nif,bat}mon
#+end_src

#+begin_src bash
sudo sysrc smartd_enable="YES"
#+end_src

#+begin_src bash
sudo pkg install docker docker-{compose,machine} minikube kubectl k9s yt-dlp icu sniffnet libvirt libvirt-dbus virt{ualbox-ose,board,-manager,-viewer} diskimage-tools masscan ezjail gstreamer1 openscad-devel libudisks wireplumber security/portacl-rc qt5-sqldrivers-{mysql,odbc,pgsql,sqlite2,sqlite3,tds} netpbm
#+end_src

#+begin_src bash
sudo sysrc libvirtd_enable="YES"
sudo sysrc vboxnet_enable="YES"
#+end_src

Add to =/boot/loader.conf=
#+begin_src bash
vboxdrv_load="YES"
#+end_src

#+begin_src bash
sudo pw groupmod vboxusers -m $USER;
sudo pw groupmod operator -m $USER;
#+end_src

Reboot machine, then:
#+begin_src bash
sudo chown root:vboxusers /dev/vboxnetctl
sudo chmod 0660 /dev/vboxnetctl
#+end_src

Add to =/etc/devfs.conf=
#+begin_src bash
own     vboxnetctl root:vboxusers
perm    vboxnetctl 0660
#+end_src


Add the following to =/etc/devfs.rules= (create if it doesn't exist):
#+begin_src bash
[system=10]
add path 'usb/*' mode 0660 group operator
#+end_src

Add the following lines in =/etc/fstab=:

#+begin_src bash
fdesc	/dev/fd		fdescfs		rw	0	0
proc	/proc		procfs		rw	0	0
#+end_src

#+begin_src sh
sudo sysrc devfs_system_ruleset="system"
#+end_src

https://wiki.freebsd.org/Docker
Create or edit =/usr/local/etc/vbox/networks.conf= and either make sure it allows the 192.168.99.1/24 network range used by docker-machine:

#+begin_src sh
sudo mkdir /usr/local/etc/vbox
sudo nvim /usr/local/etc/vbox/networks.conf
#+end_src

#+begin_src
 * 192.168.99.1/24
#+end_src

#+begin_src bash
  docker-machine create default
#+end_src

#+begin_src bash
go install github.com/jesseduffield/lazydocker@latest
#+end_src

#+begin_src
--
To enable libvirtd please add libvirtd_enable="YES" to
/etc/rc.conf.

NOTE ON CONFIGURATION:

The libvirt port does not come with networking configuration enabled.
The 'default' network definition is available at:

  /usr/local/share/examples/libvirt/networks/default.xml

To enable this network please do the following:

  cp /usr/local/share/examples/libvirt/networks/default.xml /usr/local/etc/libvirt/qemu/networks

To configure this network for autostart, execute the following:

  ln -s ../default.xml /usr/local/etc/libvirt/qemu/networks/autostart/default.xml

If you have libvirtd already running you'll need to restart it for changes
to take effect.
#+end_src

#+begin_src bash
 sudo cp /usr/local/share/examples/libvirt/networks/default.xml /usr/local/etc/libvirt/qemu/networks
#+end_src

#+begin_src bash
sudo ln -s ../default.xml /usr/local/etc/libvirt/qemu/networks/autostart/default.xml
#+end_src

#+begin_src
Message from sddm-freebsd-black-theme-1.3:
--
To enable this theme edit:

 /usr/local/etc/sddm.conf

 This theme use the x11-fonts/montserrat font by default. However, it
 can be changed to any desired font editing:

 /usr/local/share/sddm/themes/sddm-freebsd-black-theme/theme.conf
--
=====
Message from sddm-0.21.0.36_1:

--
SDDM lists a "user session" which needs either an .xinitrc in the user's
home directory, or as a fallback, xterm. In order to use the "user session"
feature, a ~/.xinitrc is recommended.
#+end_src


#+begin_src bash
sudo pkg install arduino arduino-{core,avrdude,bsd-mk} avr{dude,-gcc}
#+end_src

#+begin_src
To allow serial port locking, add your user to the dialer group:
    pw groupmod dialer -m mfarabi
    User settings are in ~/.arduino/preferences.txt.  Edit the file
when the IDE is not running.

Setting the launcher for help files:
    launcher=firefox

Showing what the IDE is doing for build and upload commands (only
visible if you started the IDE from a console):
    build.verbose=true
    upload.verbose=true

To start the IDE:
    /usr/local/bin/arduino
#+end_src

https://wiki.freebsd.org/Arduino

sudo kldload uarduno.ko

#+begin_src bash
sudo sysrc uarduno_load="YES"
#+end_src

#+begin_src bash
--
Your SDL library has been built with libvgl support, which means that you
 can run almost any SDL application straight on your console (VESA 2.0
 compatible videocard is required).

 To do this you have to load the vesa kernel module or enable it in your
 kernel, and set environment variable "SDL_VIDEODRIVER=vgl".
=====
Message from pwcview-1.4.1_9:
#+end_src


**** Set up GPU

1. Verify display device
  #+begin_src bash
  pciconf -lv | grep -B3 display
  #+end_src

  #+begin_src
  # Example output
  vgapci0@pci0:0:2:0: class=0x030000 card=...
  vendor = 'Intel Corporation'
  device = 'HD Graphics 620'
  #+end_src

2. Install graphics driver
#+begin_src bash
sudo pkg install drm-kmod # Intel
#+end_src

#+begin_src bash
sudo sysrc seatd_enable="YES"    # let non-root graphics car users manage access to shared system devices
sudo sysrc dbus_enable="YES"     # message bus and hardware abstraction
#+end_src

3. Add to =/etc/rc.conf=
#+begin_src
# ========= SERVICES/DAEMONS ===========
sshd_enable="YES"     # ssh
# sddm_enable="YES"     # login manager
smartd_enable="YES"   # disk
moused_enable="YES"   # mouse
libvirtd_enable="YES" # virtualization

# ========== KERNEL MODULES ============
kld_list="i915kms"  # kernel loadable modules - graphics

# ========== MESSAGES BUFFER ============
# net.local.stream.recvspace=65536
# net.local.stream.sendspace=65536
#+end_src

1. Modify in =/etc/ssh/sshd_config=
#+begin_src bash
PubkeyAuthentication yes
#+end_src

4. Add to =/boot/loader.conf=
#+begin_src bash
kern.vty=vt
#+end_src

#+begin_src bash
ln -s /home/mfarabi/configurations/freebsd/.local/share/bin /home/mfarabi/.local/share/
ln -s /home/mfarabi/MFarabi619/configurations/freebsd/.config/* /home/mfarabi/.config/
mkdir ~/.config/fastfetch
ln -s /home/mfarabi/MFarabi619/modules/home/programs/fastfetch/config.jsonc  /home/mfarabi/.config/fastfetch/config.jsonc
#+end_src

5. Reboot system
#+begin_src bash
reboot
#+end_src

6. Verify DRM driver
#+begin_src bash
dmesg | grep drm; ls /dev/dri;
#+end_src

Expected:
#+begin_src
[drm] Initialized i915 ...
/dev/dri/card0
/dev/dri/renderD128
#+end_src

7. Start Hyprland
#+begin_src bash
# seatd-launch hyprland
hyprland
#+end_src

#+begin_src bash
swww ~/MFarabi619/configurations/freebsd/wallpapers/freebsd-gruvbox-rainbow-dark.webp
#+end_src


*** Other
#+begin_src bash
sudo pkg install framework-system pkg_{tree,search} podman aichat ollama top {h,b,z,j,nats-,sn,usb,tree}top desktop-installer ntopng mkdesktop portopscli xdesktopwaves toppler radeon ghostscript netpbm redis qmk_hid realtek-re-{kmod,kmod198} linux-{discord,steam-utils,bitwarden-cli} win-proton libc6-shim languageclient-neovim mixertui audio/moc scrot wf-recorder
#+end_src

#+begin_src bash
sudo pkg install
bandwhich
bmon
mu rubygem-neovim
hs-ShellCheck gnuplot
xclip wininfo # for emacs-everywhere
py311-grp # markdown preview
#+end_src

#+begin_src bash
sudo kldload snd_driver
#+end_src

#+begin_src bash
sudo kldload vmm
sudo ifconfig tap0 create
sudo sysctl net.link.tap.up_on_open=1
sudo ifconfig bridge0 create
sudo ifconfig bridge0 addm ue0 addm tap0 # change `ue0` to your preferred network interface
sudo ifconfig bridge0 up
sudo truncate -s 100G guest.img
sudo sh /usr/share/examples/bhyve/vmrun.sh -c 8 -m 48000M -t tap0 -d guest.img -i -I FreeBSD-14.3-RELEASE-amd64-bootonly.iso guestname
#+end_src

#+begin_src bash
sudo kldload nullfs
#+end_src

***** Resources:
- [[https://github.com/wisonye/freebsd-handbook/blob/master/chapters/install-hyprland.org][wisonye's Personal FreeBSD Handbook - Install Hyprland]]
- [[https://lemmy.world/post/1685763][Lenny Mackners - Run Hyprland on FreeBSD]]
- [[https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=283123][i915kms regression issue]]


*** Attributions

DoomBSD borrows HEAVILY from the following projects:

- [[https://github.com/HyDE-Project/HyDE][HyDE]]
- [[https://github.com/doomemacs/doomemacs][Doom Emacs - Henrik Lissner]]
  - Reading the *Introduction* was a memorable experience and instantly had me hooked
  - DoomBSD is named in reference to this project and its philosophies
- [[https://gitlab.com/Zaney/zaneyos][ZaneyOS - Tyler Kelley]]
  - Incredibly well-structured NixOS modules and a shining example of good codebase architecture that's easily navigable
- [[https://www.lazyvim.org][LazyVim]]


* Virtual Machine Setup (WIP)

** aarch64-darwin

[[https://www.freebsd.org/where/][Download VM Image]]

#+begin_src sh
  unxz FreeBSD-15.0-RELEASE-arm64-aarch64-zfs.qcow2.xz
#+end_src

#+begin_src sh
  qemu-system-aarch64 \
    -smp 8 \
    -m 32G \
    -accel hvf \
    -cpu cortex-a72 \
    -machine virt,highmem=on \
    -device virtio-net-pci,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::2222-:22 \
    -bios /opt/homebrew/share/qemu/edk2-aarch64-code.fd \
    -drive file=FreeBSD-15.0-RELEASE-arm64-aarch64-zfs.qcow2,if=virtio,format=qcow2 \
    -nographic
#+end_src

#+begin_src sh
  qemu-img resize FreeBSD-15.0-RELEASE-arm64-aarch64-zfs.qcow2 256G
  qemu-img info FreeBSD-15.0-RELEASE-arm64-aarch64-zfs.qcow2
#+end_src


#+begin_src sh
  df -h

  # see current layout
  gpart show
  zpool status

  # enable autoexpand (so ZFS can use larger underlying device)
  zpool set autoexpand=on zroot

  # if ZFS uses the whole disk (no partition):
  zpool online -e zroot /dev/vtbd0

  # (use gpart show to find the correct index)
  gpart show
  # if ZFS is on a partition (e.g. vtbd0p2), resize that partition first if needed:
  gpart resize -i 2 vtbd0      # resize partition index 2 to fill the disk
  zpool online -e zroot /dev/vtbd0p2

  # 1) recover the GPT backup/header if needed
  gpart recover vtbd0

  # verify layout and that GPT is no longer corrupt
  gpart show vtbd0

  # 2) resize partition index 3 (freebsd-zfs) to fill the disk
  gpart resize -i 3 vtbd0

  # confirm partition grew
  gpart show vtbd0

  # 3) ask ZFS to expand the device (use the exact member name shown by zpool status)
  zpool set autoexpand=on zroot
  zpool online -e zroot vtbd0p3

  # verify pool and fs sizes
  zpool list
  zfs list
#+end_src

** amd64

#+begin_src sh
  virsh -c qemu:///system
#+end_src

#+begin_src sh
  net-start default
  net-autostart default
  net-dumpxml default
#+end_src

#+begin_src xml
  <network>
    <name>default</name>
    <uuid>04503b12-bc89-42db-811b-7ec2c6492c84</uuid>
    <forward mode='nat'>
      <nat>
        <port start='1024' end='65535'/>
      </nat>
    </forward>
    <bridge name='virbr0' stp='on' delay='0'/>
    <mac address='52:54:00:60:fe:35'/>
    <ip address='192.168.122.1' netmask='255.255.255.0'>
      <dhcp>
        <range start='192.168.122.2' end='192.168.122.254'/>
      </dhcp>
    </ip>
  </network>
#+end_src

#+begin_src sh
  mkdir $HOME/vms
  cd $HOME/vms

  # Download VM image and unzip it
  # wget https://download.freebsd.org/releases/VM-IMAGES/15.0-RELEASE/amd64/Latest/FreeBSD-15.0-RELEASE-amd64-zfs.qcow2.xz
  wget https://download.freebsd.org/releases/VM-IMAGES/15.0-RELEASE/amd64/Latest/FreeBSD-15.0-RELEASE-amd64-BASIC-CLOUDINIT-zfs.qcow2.xz

  # Decompress but keeps the original
  # xz -dk FreeBSD-15.0-RELEASE-amd64-zfs.qcow2.xz
  xz -dk FreeBSD-15.0-RELEASE-amd64-BASIC-CLOUDINIT-zfs.qcow2.xz

  # Make the disk slightly bigger
  # qemu-img resize FreeBSD-15.0-RELEASE-amd64-zfs.qcow2 350G
  qemu-img resize FreeBSD-15.0-RELEASE-amd64-BASIC-CLOUDINIT-zfs.qcow2 350G

  sudo mkdir -p /var/lib/libvirt/boot
  sudo chmod 0755 /var/lib/libvirt/boot

  sudo virt-install \
        --import \
        --vcpus 6 \
        --boot uefi \
        --memory 16384 \
        --graphics none \
        --os-variant freebsd15.0 \
        --name FreeBSD-15.0-RELEASE \
        --console pty,target_type=serial \
        --network network=default,model=virtio \
        --disk path=$HOME/vms/seed.iso,device=cdrom \
        --disk path=$HOME/vms/FreeBSD-15.0-RELEASE-amd64-BASIC-CLOUDINIT-zfs.qcow2,format=qcow2,bus=virtio
#+end_src

#+begin_src sh
  sudo virsh list --all
  sudo virsh domifaddr FreeBSD-15.0-RELEASE
  sudo virsh destroy FreeBSD-15.0-RELEASE
  sudo virsh undefine FreeBSD-15.0-RELEASE --nvram
  rm ~/vms/FreeBSD-15.0-RELEASE-amd64-BASIC-CLOUDINIT-zfs.qcow2
  sudo cloud-localds ~/vms/seed.iso ~/MFarabi619/configurations/freebsd/doombsd/user-data.yaml
  xz -dk ~/vms/FreeBSD-15.0-RELEASE-amd64-BASIC-CLOUDINIT-zfs.qcow2.xz
  qemu-img resize ~/vms/FreeBSD-15.0-RELEASE-amd64-BASIC-CLOUDINIT-zfs.qcow2 350G
#+end_src

** Run NixOS VM Guest

#+begin_src sh
  qemu-system-x86_64 \
    -smp 3 \
    -m 8000 \
    -boot d \
    -net nic \
    -net user,hostfwd=tcp::2222-:22 \
    -drive file=nixos-25.11-x86_64.qcow2,format=qcow2 \
    -cdrom /home/mfarabi/QEMU/ISO/latest-nixos-graphical-x86_64-linux.iso
#+end_src

* Set up Caddy (WIP)

#+begin_src sh
  Proceed with this action? [y/N]: y
  [1/1] Fetching caddy-2.10.2_4.pkg: 100%   13 MiB  13.7MB/s    00:01
  Checking integrity... done (0 conflicting)
  [1/1] Installing caddy-2.10.2_4...
  ===> Creating groups
  Using existing group 'www'
  ===> Creating users
  Using existing user 'www'
  [1/1] Extracting caddy-2.10.2_4: 100%
  =====
  Message from caddy-2.10.2_4:

  --
  To enable caddy:

  - Edit /usr/local/etc/caddy/Caddyfile
    See https://caddyserver.com/docs/
  - Run 'service caddy enable'

  Note while Caddy currently defaults to running as root:wheel, it is strongly
  recommended to run the server as an unprivileged user, such as www:www --

  - Use security/portacl-rc to enable privileged port binding:

    # pkg install security/portacl-rc
    # sysrc portacl_users+=www
    # sysrc portacl_user_www_tcp="http https"
    # sysrc portacl_user_www_udp="https"
    # service portacl enable
    # service portacl start

  - Configure caddy to run as www:www

    # sysrc caddy_user=www caddy_group=www

  - Note if Caddy has been started as root previously, files in
    /var/log/caddy, /var/db/caddy, and /var/run/caddy may require their ownership
    changing manually.

  /usr/local/etc/rc.d/caddy has the following defaults:

  - Server log: /var/log/caddy/caddy.log
    (runtime messages, NOT an access.log)
  - Automatic SSL certificate storage: /var/db/caddy/data/caddy/
  - Administration endpoint: //unix/var/run/caddy/caddy.sock
  - Runs as root:wheel (this will change to www:www in the future)
#+end_src
