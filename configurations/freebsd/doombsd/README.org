Work in Progress.

=man tuning=

*** Connect to network

=bsdconfig= or =dhclient ue0=

*** Enable =sudo=

*** Set up shell
#+begin_src bash
pkg update && pkg upgrade
#+end_src

#+begin_src bash
sudo pkg install yazi git bash zsh bat lazygit lf terminfo-db dunst mpv direnv zellij markdown markdownfmt jetbrains-mono nerd-fonts noto-emoji npm vips docker docker-compose k9s
#+end_src

#+begin_src bash
fc-cache -fv
#+end_src

#+begin_src bash
curl -fsSL https://git.io/shellspec | sh
#+end_src

#+begin_src bash
sudo pkg install tree eza fzf ripgrep ripgrep-all
#+end_src

#+begin_src bash
sudo pkg install s-tui stress smartmontools gnupg symon sysmon nifmon batmon
#+end_src

#+begin_src bash
sudo pkg install procs btop fastfetch cmatrix cowsay asciiquarium figlet lolcat nyancat rgb-tui
#+end_src

[[https://ohmyz.sh/][Oh My Zsh]]
#+begin_src bash
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
#+end_src

[[https://github.com/romkatv/powerlevel10k][PowerLevel10K]]
#+begin_src bash
git clone https://github.com/romkatv/powerlevel10k.git $ZSH_CUSTOM/themes/powerlevel10k
#+end_src

[[https://github.com/zsh-users/zsh-autosuggestions][zsh-autosuggestions]]
#+begin_src bash
git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
#+end_src

[[https://github.com/zsh-users/zsh-syntax-highlighting][zsh-syntax-highlighting]]
#+begin_src bash
git clone https://github.com/zsh-users/zsh-syntax-highlighting ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
#+end_src

Edit =ZSH_THEME= in =~/.zshrc=
#+begin_src bash
ZSH_THEME="powerlevel10k/powerlevel10k"
#+end_src

Add plugins to =~/.zshrc=.
#+begin_src bash
plugins=(git zsh-autosuggestions zsh-syntax-highlighting)
#+end_src

Source =~/.zshrc=:
#+begin_src bash
rm ~/.zshrc; ln -s /home/mfarabi/MFarabi619/configurations/freebsd/.zshrc ~/.zshrc;
rm ~/.p10k.zsh; ln -s /home/mfarabi/MFarabi619/configurations/freebsd/.p10k.zsh ~/.p10k.zsh; source ~/.zshrc;
rm -rf ~/.config/hypr; ln -s /home/mfarabi/MFarabi619/modules/home/programs/hyprland/hypr /home/mfarabi/.config/hypr;
#+end_src

#+begin_src bash
/home/mfarabi/.local/lib/shellspec/bin/shellspec . --format documentation
#+end_src

*** Set up editors

#+begin_src bash
sudo pkg install neovim py311-pynvim emacs-devel ffmpegthumbnailer coreutils cmake poppler 7-zip aspell en-aspell aspell-ispell
#+end_src

[[https://www.lazyvim.org/installation][Lazyvim]]
#+begin_src bash
git clone https://github.com/LazyVim/starter ~/.config/nvim; rm -rf ~/.config/nvim/.git;
#+end_src

[[https://github.com/doomemacs/doomemacs?tab=readme-ov-file#install][Doom Emacs]]
#+begin_src bash
git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.config/emacs; ~/.config/emacs/bin/doom install;
rm -rf ~/.config/doom/*; ln -s /home/mfarabi/MFarabi619/modules/home/programs/emacs/* /home/mfarabi/.config/doom/
#+end_src

*** Set up FreeBSD Hyprland

1. Add user to =video= group
  #+begin_src bash
  pw groupmod video -m mfarabi; groups mfarabi;
  #+end_src

- Switch to root user then visudo.

wheel NOPASSWD all

#+begin_src bash
sudo pkg install dbus xdg-desktop-portal xdg-terminal-exec
#+end_src

#+begin_src bash
sudo kldload fusefs
#+end_src

#+begin_src bash
sudo pkg install wayland wayland-logout wayland-protocols wayland-utils qt6-wayland
#+end_src

#+begin_src bash
sudo pkg install xwayland xwaylandvideobridge xwayland-satellite xwayland-run
#+end_src

#+begin_src bash
sudo pkg install hyprland hyprland-qt-support hyprland-qtutils nwg-dock-hyprland xdg-desktop-portal-hyprland alacritty
#+end_src

#+begin_src bash
sudo pkg install sddm-freebsd-black-theme
#+end_src

#+begin_src bash
sudo pkg install hyprgraphics hyprlang hyprutils hyprland hyprwayland-scanner hyprsunset hypridle hyprlock hyprpaper hyprpicker
#+end_src

#+begin_src bash
sudo pkg install imlib2-jxl gimp-jxl-plugin mousepad
#+end_src

#+begin_src bash
sudo pkg install rofi waybar wlogout dolphin pavucontrol wl-clipboard swaylock-effects
#+end_src

#+begin_src bash
sudo pkg install cava nwg-look wifimgr byobu kvantum nsxiv pamixer pa-applet wmwifi sddm aimage qimageblitz qt6-imageformats xloadimage terminal-image-viewer bsd-splash-changer bsdebfetch bsdinfo bsdsensors pwcbsd wmbsdbatt openconnect-freebsd-daemon viewglob sysctlview
#+end_src

#+begin_src bash
sudo kldload sysctlinfo
#+end_src

#+begin_src bash
sudo pkg install webcamd pwcview fontpreview epdfview glcapsviewer swww pango cairo pipewire grim slurp
#+end_src

#+begin_src bash
sudo sysrc webcamd_enable=YES
#+end_src
#+begin_src bash
sudo service devd restart
#+end_src
#+begin_src bash
sudo pw groupmod webcamd -m mfarabi
#+end_src
#+begin_src bash
sudo kldload cuse
#+end_src
#+begin_src bash
sudo sysrc kld_list+=cuse
#+end_src
#+begin_src bash
sudo webcamd -l
#+end_src

2. Install packages
#+begin_src bash
pkg install yt-dlp unzip icu  sniffnet libvirt libvirt-dbus virtboard virt-manager virt-viewer pkg_tree vlc texlive-full diskimage-tools kubectl minikube masscan ezjail  gstreamer1 openscad-devel libudisks wireplumber security/portacl-rc virtualbox-ose qt5-sqldrivers-mysql qt5-sqldrivers-odbc qt5-sqldrivers-pgsql qt5-sqldrivers-sqlite2 qt5-sqldrivers-sqlite3 qt5-sqldrivers-tds netpbm
#+end_src

#+begin_src
--
To enable libvirtd please add libvirtd_enable="YES" to
/etc/rc.conf.

NOTE ON CONFIGURATION:

The libvirt port does not come with networking configuration enabled.
The 'default' network definition is available at:

  /usr/local/share/examples/libvirt/networks/default.xml

To enable this network please do the following:

  cp /usr/local/share/examples/libvirt/networks/default.xml /usr/local/etc/libvirt/qemu/networks

To configure this network for autostart, execute the following:

  ln -s ../default.xml /usr/local/etc/libvirt/qemu/networks/autostart/default.xml

If you have libvirtd already running you'll need to restart it for changes
to take effect.
#+end_src

#+begin_src bash
sudo sysrc libvirtd_enable="YES"
#+end_src

#+begin_src bash
 sudo cp /usr/local/share/examples/libvirt/networks/default.xml /usr/local/etc/libvirt/qemu/networks
#+end_src

#+begin_src bash
sudo ln -s ../default.xml /usr/local/etc/libvirt/qemu/networks/autostart/default.xml
#+end_src

#+begin_src
Message from sddm-freebsd-black-theme-1.3:

--
To enable this theme edit:

 /usr/local/etc/sddm.conf

 This theme use the x11-fonts/montserrat font by default. However, it
 can be changed to any desired font editing:

 /usr/local/share/sddm/themes/sddm-freebsd-black-theme/theme.conf
--
===>   NOTICE:

The sddm-freebsd-black-theme port currently does not have a maintainer. As a result, it is
more likely to have unresolved issues, not be up-to-date, or even be removed in
the future. To volunteer to maintain this port, please create an issue at:

https://bugs.freebsd.org/bugzilla

More information about port maintainership is available at:

https://docs.freebsd.org/en/articles/contributing/#ports-contributing
=====
Message from sddm-0.21.0.36_1:

--
SDDM lists a "user session" which needs either an .xinitrc in the user's
home directory, or as a fallback, xterm. In order to use the "user session"
feature, a ~/.xinitrc is recommended.
#+end_src

#+begin_src bash
sudo pw groupmod vboxusers -m mfarabi;
sudo pw groupmod operator -m mfarabi;
#+end_src

Add the following to =/etc/devfs.rules= (create if it doesn't exist):
#+begin_src bash
[system=10]
add path 'usb/*' mode 0660 group operator
#+end_src

Add the following lines in =/etc/fstab=:

#+begin_src bash
fdesc	/dev/fd		fdescfs		rw	0	0
proc	/proc		procfs		rw	0	0
#+end_src

#+begin_src bash
sudo pkg install arduino arduino-avrdude avr-gcc avrdude arduino-bsd-mk arduino-core
#+end_src

#+begin_src
To allow serial port locking, add your user to the dialer group:
    pw groupmod dialer -m mfarabi
    User settings are in ~/.arduino/preferences.txt.  Edit the file
when the IDE is not running.

Setting the launcher for help files:
    launcher=firefox

Showing what the IDE is doing for build and upload commands (only
visible if you started the IDE from a console):
    build.verbose=true
    upload.verbose=true

To start the IDE:
    /usr/local/bin/arduino
#+end_src

https://wiki.freebsd.org/Arduino

sudo kldload uarduno.ko

#+begin_src bash
sudo sysrc uarduno_load="YES"
#+end_src


#+begin_src bash
--
Your SDL library has been built with libvgl support, which means that you
 can run almost any SDL application straight on your console (VESA 2.0
 compatible videocard is required).

 To do this you have to load the vesa kernel module or enable it in your
 kernel, and set environment variable "SDL_VIDEODRIVER=vgl".
=====
Message from pwcview-1.4.1_9:
#+end_src

#+begin_src bash
sudo pkg install ly
#+end_src

#+begin_src bash
Add the following entry to /etc/gettytab:

Ly:\
	:lo=/usr/local/bin/ly:\
	:al=root:

#+end_src

Modify the command field of the ttyv1 terminal entry in /etc/ttys

#+begin_src bash
ttyv1   "/usr/libexec/getty Ly"     xterm onifexists secure
#+end_src

Make sure that "tty" is set appropriately in the /usr/local/etc/ly/config.ini file if
you decide to configure a different TTY for Ly instead.

**** Set up GPU

1. Verify display device
  #+begin_src bash
  pciconf -lv | grep -B3 display
  #+end_src

  #+begin_src
  # Example output
  vgapci0@pci0:0:2:0: class=0x030000 card=...
  vendor = 'Intel Corporation'
  device = 'HD Graphics 620'
  #+end_src

2. Install graphics driver
#+begin_src bash
pkg install drm-kmod # Intel
#+end_src

3. Add to =/etc/rc.conf=
#+begin_src
# ========= SERVICES/DAEMONS ===========
seatd_enable="YES"    # let non-root graphics car users manage access to shared system devices
moused_enable="YES"   # mouse
sshd_enable="YES"     # ssh
dbus_enable="YES"     # message bus and hardware abstraction
smartd_enable="YES"   # disk
sddm_enable="YES"     # login manager
libvirtd_enable="YES" # virtualization

# ========== KERNEL MODULES ============
kld_list="i915kms"  # kernel loadable modules - graphics

# ========== MESSAGES BUFFER ============
# net.local.stream.recvspace=65536
# net.local.stream.sendspace=65536
#+end_src

1. Modify in =/etc/ssh/sshd_config=
#+begin_src bash
PubkeyAuthentication yes
#+end_src

4. Add to =/boot/loader.conf=
#+begin_src bash
kern.vty=vt
#+end_src

#+begin_src bash
ln -s /home/mfarabi/configurations/freebsd/.local/share/bin /home/mfarabi/.local/share/
ln -s /home/mfarabi/MFarabi619/configurations/freebsd/.config/* /home/mfarabi/.config/
#+end_src

5. Reboot system
#+begin_src bash
reboot
#+end_src

6. Verify DRM driver
#+begin_src bash
dmesg | grep drm; ls /dev/dri;
#+end_src

Expected:
#+begin_src
[drm] Initialized i915 ...
/dev/dri/card0
/dev/dri/renderD128
#+end_src

7. Start Hyprland
#+begin_src bash
# seatd-launch hyprland
hyprland
#+end_src


*** Other
#+begin_src bash
sudo pkg install systeroid sysctl-tui framework-system television pkg_search podman aichat ollama python ztop desktop-installer htop jtop ntopng nats-top mkdesktop portopscli sntop xdesktopwaves usbtop treetop toppler radeon top ghostscript netpbm redis wl-gammarelay-rs wl-mkbptr wl-screenrec networkmgr firefox gh ttyd sysutils/lazyssh qmk_hid realtek-re-kmod realtek-re-kmod198 linux-steam-utils win-proton libc6-shim tree-sitter tailscale languageclient-neovim firefox linux-bitwarden-cli mixertui audio/moc scrot wf-recorder tree-sitter-graph
#+end_src

#+begin_src bash
sudo sysrc tailscaled_enable="YES"
#+end_src

#+begin_src bash
sudo pkg install texlive-full
#+end_src

#+begin_src bash
sudo pkg install
bandwhich
bmon
shfmt mu rubygem-neovim
hs-ShellCheck gnuplot
xclip wininfo # for emacs-everywhere
py311-grp # markdown preview
linux-discord
#+end_src

#+begin_src bash
sudo kldload snd_driver
#+end_src

#+begin_src bash
sudo kldload vmm
sudo ifconfig tap0 create
sudo sysctl net.link.tap.up_on_open=1
sudo ifconfig bridge0 create
sudo ifconfig bridge0 addm ue0 addm tap0 # change `ue0` to your preferred network interface
sudo ifconfig bridge0 up
sudo truncate -s 100G guest.img
sudo sh /usr/share/examples/bhyve/vmrun.sh -c 8 -m 48000M -t tap0 -d guest.img -i -I FreeBSD-14.3-RELEASE-amd64-bootonly.iso guestname
#+end_src

#+begin_src bash
sudo kldload nullfs
#+end_src


#+begin_src bash
sudo ya pkg add yazi-rs/plugins:{git,mime-ext,smart-enter,smart-filter,smart-paste,chmod,mount,toggle-pane,vcs-files,zoom}
#+end_src

#+begin_src bash
sudo pkg install go wget unzip
#+end_src

***** Resources:
- [[https://github.com/wisonye/freebsd-handbook/blob/master/chapters/install-hyprland.org][wisonye's Personal FreeBSD Handbook - Install Hyprland]]
- [[https://lemmy.world/post/1685763][Lenny Mackners - Run Hyprland on FreeBSD]]
- [[https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=283123][i915kms regression issue]]


*** Attributions

DoomBSD borrows HEAVILY from the following projects:

- [[https://github.com/HyDE-Project/HyDE][HyDE]]
- [[https://github.com/doomemacs/doomemacs][Doom Emacs - Henrik Lissner]]
  - Reading the *Introduction* was a memorable experience and instantly had me hooked
  - DoomBSD is named in reference to this project and its philosophies
- [[https://gitlab.com/Zaney/zaneyos][ZaneyOS - Tyler Kelley]]
  - Incredibly well-structured NixOS modules and a shining example of good codebase architecture that's easily navigable
- [[https://www.lazyvim.org][LazyVim]]


* Virtual Machine Setup (WIP)

** aarch64-darwin

[[https://www.freebsd.org/where/][Download VM Image]]

#+begin_src sh
unxz FreeBSD-15.0-RELEASE-arm64-aarch64-zfs.qcow2.xz
#+end_src

#+begin_src sh
qemu-system-aarch64 \
  -machine virt,highmem=on \
  -accel hvf \
  -cpu cortex-a72 \
  -smp 8 \
  -m 32G \
  -drive file=FreeBSD-15.0-RELEASE-arm64-aarch64-zfs.qcow2,if=virtio,format=qcow2 \
  -device virtio-net-pci,netdev=net0 \
  -netdev user,id=net0,hostfwd=tcp::2222-:22 \
  -bios /opt/homebrew/share/qemu/edk2-aarch64-code.fd \
  -nographic
#+end_src

#+begin_src sh
qemu-img resize FreeBSD-15.0-RELEASE-arm64-aarch64-zfs.qcow2 256G
qemu-img info FreeBSD-15.0-RELEASE-arm64-aarch64-zfs.qcow2
#+end_src


#+begin_src sh
df -h

# see current layout
gpart show
zpool status

# enable autoexpand (so ZFS can use larger underlying device)
zpool set autoexpand=on zroot

# if ZFS uses the whole disk (no partition):
zpool online -e zroot /dev/vtbd0

# (use gpart show to find the correct index)
gpart show
# if ZFS is on a partition (e.g. vtbd0p2), resize that partition first if needed:
gpart resize -i 2 vtbd0      # resize partition index 2 to fill the disk
zpool online -e zroot /dev/vtbd0p2

# 1) recover the GPT backup/header if needed
gpart recover vtbd0

# verify layout and that GPT is no longer corrupt
gpart show vtbd0

# 2) resize partition index 3 (freebsd-zfs) to fill the disk
gpart resize -i 3 vtbd0

# confirm partition grew
gpart show vtbd0

# 3) ask ZFS to expand the device (use the exact member name shown by zpool status)
zpool set autoexpand=on zroot
zpool online -e zroot vtbd0p3

# verify pool and fs sizes
zpool list
zfs list
#+end_src

** Run NixOS VM Guest

qemu-system-x86_64 \
-m 8000 \
-smp 3 \
-drive file=nixos-25.11-x86_64.qcow2,format=qcow2 \
-cdrom /home/mfarabi/QEMU/ISO/latest-nixos-graphical-x86_64-linux.iso \
-boot d \
-net nic \
-net user,hostfwd=tcp::2222-:22

* Set up Caddy (WIP)

#+begin_src sh
Proceed with this action? [y/N]: y
[1/1] Fetching caddy-2.10.2_4.pkg: 100%   13 MiB  13.7MB/s    00:01
Checking integrity... done (0 conflicting)
[1/1] Installing caddy-2.10.2_4...
===> Creating groups
Using existing group 'www'
===> Creating users
Using existing user 'www'
[1/1] Extracting caddy-2.10.2_4: 100%
=====
Message from caddy-2.10.2_4:

--
To enable caddy:

- Edit /usr/local/etc/caddy/Caddyfile
  See https://caddyserver.com/docs/
- Run 'service caddy enable'

Note while Caddy currently defaults to running as root:wheel, it is strongly
recommended to run the server as an unprivileged user, such as www:www --

- Use security/portacl-rc to enable privileged port binding:

  # pkg install security/portacl-rc
  # sysrc portacl_users+=www
  # sysrc portacl_user_www_tcp="http https"
  # sysrc portacl_user_www_udp="https"
  # service portacl enable
  # service portacl start

- Configure caddy to run as www:www

  # sysrc caddy_user=www caddy_group=www

- Note if Caddy has been started as root previously, files in
  /var/log/caddy, /var/db/caddy, and /var/run/caddy may require their ownership
  changing manually.

/usr/local/etc/rc.d/caddy has the following defaults:

- Server log: /var/log/caddy/caddy.log
  (runtime messages, NOT an access.log)
- Automatic SSL certificate storage: /var/db/caddy/data/caddy/
- Administration endpoint: //unix/var/run/caddy/caddy.sock
- Runs as root:wheel (this will change to www:www in the future)
#+end_src
